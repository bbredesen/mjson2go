<html>

<head>
    <meta charset="utf-8" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
        crossorigin="anonymous"></script>

    <script src="wasm_exec.js"></script>
    <script>
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("mjson2go.wasm"), go.importObject).then((result) => {
            go.run(result.instance);
        });
    </script>

<script>
    var goGenerateIt = function () {
        document.getElementById('jsoninput').value = fixSourceErrors( document.getElementById('jsoninput').value )
        // jsoninput.val(fixSourceErrors(jsoninput.value));

        gooutput.value = buildFunction(jsoninput.value, 'GetAggregation');
    }
</script>


</head>

<body>
    <div class="container">
        <h1>mjson2go Online Demo</h1>
        <p><code>mjson2go</code> is a tool that generates parameterized Go code usable by the MongoDB driver from a JSON
            pipeline source.</p>

        <p>Want to include this in your development workflow? See the <a
                href="https://github.com/bbredesen/mjson2go">project on Github</a> for full docs and command line options.</p>

    </div>

    <div class="container">
        <div class="row align-items-center">
            <div class="col">

                <textarea id="jsoninput" name="jsoninput" class="form-control"
                    placeholder="Paste or type your pipeline as JSON" rows="16">[
    { "$match" : {
            "postType" : "Article",
            "postDate": {"$lt": "%%beforeDate%time.Time" }
        }
    },
    { "$group" : {
            "_id" : { "user" : "$userId" },
            "allPosts": { "$push" : "$$ROOT" },
            "count" : { "$sum" : 1 }
        }
    }
]
</textarea>
            </div>
            <div class="col-2" style="text-align: center;">
                <button type="button" class="btn btn-primary" onclick="goGenerateIt()">Go Generate It &#10140;</button>
            </div>
            <div class="col">
                <textarea id="gooutput" name="gooutput" class="form-control" placeholder="Go code will appear here"
                    rows="16"></textarea>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>Pipeline Parameters</h2>

        <p>Input parameters can be specified as a string in your JSON file prefixed with "%%", and optionally with a Go
            type specification and ordering for the function arguments:</p>
        <pre>
{
    "index": "%%usingIndex%int%2",
    "date": "%%searchDate%time.Time%1"
}
</pre>

        <p>This will produce a function similar to:</p>
<pre>
func GetAggregation(searchDate time.Time, usingIndex int) bson.D {
    // ... 
}</pre>
    </div>
</body>

</html>